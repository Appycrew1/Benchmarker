<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Moving Benchmark + Heatmap — MVP Plus</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  #app{display:grid;grid-template-columns:2fr 1fr;grid-template-rows:auto 1fr;height:100vh}
  #toolbar{grid-column:1/3;display:flex;gap:8px;padding:10px;border-bottom:1px solid #ddd;align-items:center;flex-wrap:wrap}
  #map{grid-column:1/2;grid-row:2/3}
  #panel{grid-column:2/3;grid-row:2/3;padding:12px;overflow:auto;border-left:1px solid #ddd}
  button,select,input{padding:8px;font-size:14px}
  .tabbar{display:flex;gap:8px;margin-bottom:8px}
  .tabbar button{border:1px solid #ccc;background:#fafafa;cursor:pointer}
  .tabbar button.active{background:#eaeaea}
  .section{display:none}
  .section.active{display:block}
  .metric{font-size:14px;margin:4px 0}
</style>
</head>
<body>
<div id="app">
  <div id="toolbar">
    <strong>MVP Plus</strong>
    <span style="opacity:.6">— Heatmap • Benchmark • Forecast • Pricing • Competitor Watch • Lead Score • Marketing</span>
  </div>

  <div id="map"></div>

  <div id="panel">
    <div class="tabbar">
      <button data-tab="benchmark" class="active">Benchmark</button>
      <button data-tab="forecast">Forecast</button>
      <button data-tab="pricing">Pricing</button>
      <button data-tab="watch">Competitor Watch</button>
      <button data-tab="lead">Lead Score</button>
      <button data-tab="marketing">Marketing</button>
    </div>

    <div style="margin-bottom:10px">
      <label>Area</label>
      <select id="area"></select>
    </div>

    <div id="benchmark" class="section active">
      <div style="margin-bottom:6px">
        <label>Your hourly rate (£)</label>
        <input id="yourRate" type="number" placeholder="e.g. 110"/>
      </div>
      <div style="margin-bottom:6px">
        <label>Your review score (0-5)</label>
        <input id="yourReview" type="number" step="0.1" placeholder="e.g. 4.3"/>
      </div>
      <button id="compareBtn">Compare</button>
      <h3>Area Metrics</h3>
      <div id="metrics"></div>
      <h3>You vs. Area</h3>
      <canvas id="chart" height="180"></canvas>
      <h3>Suggested Actions</h3>
      <ul id="insights"></ul>
    </div>

    <div id="forecast" class="section">
      <p>30-day demand forecast for selected area.</p>
      <canvas id="forecastChart" height="180"></canvas>
    </div>

    <div id="pricing" class="section">
      <button id="pricingBtn">Get Pricing Recommendation</button>
      <pre id="pricingOut" style="white-space:pre-wrap"></pre>
    </div>

    <div id="watch" class="section">
      <button id="watchBtn">Check Competitor Watch</button>
      <pre id="watchOut" style="white-space:pre-wrap"></pre>
    </div>

    <div id="lead" class="section">
      <div style="margin-bottom:6px">
        <label>Estimated job value (£)</label>
        <input id="jobVal" type="number" value="520"/>
      </div>
      <div style="margin-bottom:6px">
        <label>Your review score (0-5)</label>
        <input id="leadReview" type="number" step="0.1" value="4.3"/>
      </div>
      <button id="leadBtn">Score Lead</button>
      <pre id="leadOut" style="white-space:pre-wrap"></pre>
    </div>

    <div id="marketing" class="section">
      <button id="marketingBtn">Marketing Recommendations</button>
      <pre id="marketingOut" style="white-space:pre-wrap"></pre>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
let map=L.map('map').setView([51.509,-0.118],11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let heatLayer;let markers=[];

const qs = (sel)=>document.querySelector(sel);
const qsa = (sel)=>Array.from(document.querySelectorAll(sel));
function setTab(id){
  qsa('.section').forEach(s=>s.classList.remove('active'));
  qsa('.tabbar button').forEach(b=>b.classList.remove('active'));
  qs('#'+id).classList.add('active');
  qs(`.tabbar button[data-tab="${id}"]`).classList.add('active');
}
qsa('.tabbar button').forEach(btn=>btn.onclick=()=>setTab(btn.dataset.tab));

async function loadAreas(){
  const res = await fetch('/api/areas');
  const areas = await res.json();
  const sel = qs('#area'); sel.innerHTML='';
  areas.forEach(a=>{
    const opt=document.createElement('option'); opt.value=a.code; opt.textContent=`${a.code} — ${a.name}`; sel.appendChild(opt);
    const m=L.circleMarker([a.lat,a.lng],{radius:6}).addTo(map); m.bindTooltip(`${a.code} — ${a.name}`); markers.push(m);
  });
  return areas;
}
async function loadHeat(){
  const res = await fetch('/api/heatmap'); const pts = await res.json();
  if(heatLayer) heatLayer.remove(); heatLayer=L.heatLayer(pts,{radius:25,blur:15}).addTo(map);
}
async function showMetrics(code){
  const m = await fetch('/api/metrics?area_code='+code).then(r=>r.json());
  const box = qs('#metrics');
  if(m.error){box.textContent=m.error;return;}
  box.innerHTML = [
    `<div class="metric"><b>Demand:</b> ${m.demand_index}</div>`,
    `<div class="metric"><b>Competition:</b> ${m.competition_index}</div>`,
    `<div class="metric"><b>Avg Hourly Rate:</b> £${m.avg_hourly_rate}</div>`,
    `<div class="metric"><b>Avg Review Score:</b> ${m.avg_review_score}★</div>`,
    `<div class="metric"><b>Close Rate:</b> ${m.close_rate_pct}%</div>`,
    `<div class="metric"><b>On-time:</b> ${m.on_time_pct}%</div>`,
    `<div class="metric"><b>Avg Job Value:</b> £${m.avg_job_value}</div>`,
    `<div class="metric"><b>Competitor Avg Rate:</b> £${m.competitor_avg_rate}</div>`,
  ].join("");
}
let chart;
function renderChart(yourRate, areaRate, yourRev, areaRev){
  const ctx=qs('#chart'); if(chart) chart.destroy();
  chart=new Chart(ctx,{type:'bar',data:{labels:['Hourly Rate','Review Score'],datasets:[{label:'You',data:[yourRate||0,yourRev||0]},{label:'Area',data:[areaRate,areaRev]}]},options:{responsive:true,scales:{y:{beginAtZero:true}}}});
}
let forecastChart;
async function renderForecast(code){
  const data = await fetch(`/api/forecast?area_code=${code}&horizon_days=30`).then(r=>r.json());
  const ctx=qs('#forecastChart'); if(forecastChart) forecastChart.destroy();
  const labels = data.points.map(p=>'D'+p.day);
  const values = data.points.map(p=>p.forecast_demand);
  forecastChart=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Demand Forecast (30d)',data:values}]},options:{responsive:true,scales:{y:{beginAtZero:true,max:100}}}});
}

qs('#compareBtn').onclick=async()=>{
  const code=qs('#area').value;
  const yourRate=parseFloat(qs('#yourRate').value||'0');
  const yourRev=parseFloat(qs('#yourReview').value||'0');
  const b=await fetch(`/api/benchmark?area_code=${code}&your_hourly_rate=${yourRate}&your_review_score=${yourRev}`).then(r=>r.json());
  await showMetrics(code);
  const ins=await fetch('/api/insights?area_code='+code).then(r=>r.json());
  qs('#insights').innerHTML=(ins.insights||[]).map(x=>'<li>'+x+'</li>').join('');
  renderChart(yourRate,b.area_avg.hourly_rate,yourRev,b.area_avg.review_score);
};
qs('#pricingBtn').onclick=async()=>{ const code=qs('#area').value; const data=await fetch('/api/pricing?area_code='+code).then(r=>r.json()); qs('#pricingOut').textContent=JSON.stringify(data.pricing, null, 2); };
qs('#watchBtn').onclick=async()=>{ const code=qs('#area').value; const data=await fetch('/api/competitor_watch?area_code='+code).then(r=>r.json()); qs('#watchOut').textContent=JSON.stringify(data, null, 2); };
qs('#leadBtn').onclick=async()=>{
  const code=qs('#area').value; const jobVal=parseFloat(qs('#jobVal').value||'520'); const rev=parseFloat(qs('#leadReview').value||'4.3');
  const data=await fetch(`/api/lead_score?area_code=${code}&est_job_value=${jobVal}&your_review_score=${rev}`).then(r=>r.json());
  qs('#leadOut').textContent=JSON.stringify(data, null, 2);
};
qs('#marketingBtn').onclick=async()=>{ const data=await fetch('/api/marketing').then(r=>r.json()); qs('#marketingOut').textContent=JSON.stringify(data.ranking, null, 2); };

(async function init(){
  await loadAreas(); await loadHeat();
  const first=qs('#area').value;
  if(first){
    await showMetrics(first);
    await renderForecast(first);
    const ins=await fetch('/api/insights?area_code='+first).then(r=>r.json());
    qs('#insights').innerHTML=(ins.insights||[]).map(x=>'<li>'+x+'</li>').join('');
  }
  qs('#area').addEventListener('change', async (e)=>{ await showMetrics(e.target.value); await renderForecast(e.target.value); });
})();
</script>
</body>
</html>
